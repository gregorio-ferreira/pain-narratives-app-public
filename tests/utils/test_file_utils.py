from __future__ import annotations

import base64
import io

import pytest

from pain_narratives.utils import file_to_markdown


_DOCX_BASE64 = """
UEsDBBQAAAAIAFGFPFuF+Ddc5QAAAKcBAAATAAAAW0NvbnRlbnRfVHlwZXNdLnhtbH2Qy07DMBBF9/0Ky1sUO7BACCXpgscSWJQPGNmTxMIvedxS/p5JC0VClKV1H8dzu/U+eLHDQi7FXl6qVgqMJlkXp16+bh6bG7keVt3mIyMJ9kbq5VxrvtWazIwBSKWMkZUxlQCVn2XSGcwbTKiv2vZamxQrxtrUpUMOKyG6exxh66t42LNyRBf0JMXd0bvg
egk5e2egsq530f4CNV8QxcmDh2aX6YINUp+DLOJ5xk/0mRcpzqJ4gVKfILBRv6ditU1mGzis/m/647dpHJ3BU35pyyUZJOKpg1cnJYCL31d0+jD88AlQSwMEFAAAAAgA
UYU8WzzDyG+oAAAAHQEAAAsAAABfcmVscy8ucmVsc42POw7CMBBE+5zC2p5sQoEQwkmDkNKicADL3jgR8Ue2+d0eFxQEUVDu7Mwbzb59mJndKMTJWQ51WQEjK52arOZw
7o+rLbRNsT/RLFK2xHHykeWMjRzGlPwOMcqRjIil82TzZ3DBiJTPoNELeRGacF1VGwyfDGgKxhZY1ikOoVM1sP7p6R+8G4ZJ0sHJqyGbfrR8OTJZBE2Jw90FheotlxkL
mFfiYmbzAlBLAwQUAAAACABRhTxbTD18Tm8AAAB8AAAAHAAAAHdvcmQvX3JlbHMvZG9jdW1lbnQueG1sLnJlbHNNjEEOAiEMRfeegnTvFF0YY4aZnQcweoAGKxCHQigx
Hl+WLn/ee39ev3kzH26aijg4TBYMiy/PJMHB437dn2FddvONN+pD0ZiqmtGIOoi91wui+siZdCqVZZBXaZn6mC1gJf+mwHi09oTt/wNw+QFQSwMEFAAAAAgAUYU8W5Bm
VNPsAQAA7wUAABEAAAB3b3JkL2RvY3VtZW50LnhtbKWUS2/bMAyA7/kVhu+J7SzrAiNODw3W9TCsQFdgV0WWbaGSKEiyvezXj7ITPzBgy5qTSJD8+JDE3f1PKYKGGctB
ZWGyisOAKQo5V2UWvn7/vNyGgXVE5USAYll4Yja83y92bZoDrSVTLkCCsmmraRZWzuk0iiytmCR2JTk1YKFwKwoygqLglEUtmDxax0ncSdoAZdZiugeiGmLDxZkn/8SB
ZgqNBRhJHKqmjCQxb7VeIl4Tx49ccHdCeHw3cCALa6PSM2M5lORj0r6k8zGEmGsy9zGH8xC6nJFhAqsAZSuuJ528F4fGaqA0f+ujkWJwbHWyue0mDoa0eEyI13SQ91FS
9MX/A5nEV9yLZ4wh1xQxz3qpRRKuJqnfNZ7ZhMvbBvxooNYTHL8N96TeRpj/pP8BO9/UrDt7WzkvFdH+M0maPpUKDDkKrAnHHvinGe4XQYDr4wj5yYudonupk81F7jS3
/8KEgODw7eFHoIgx+MEatou85RITDUFe1APVMuqezQSty5dfQetfUrJeb3DVtWmF8sctytHM7ysxaHSALz/Z9J6Gl5Ub1SM4B3LUBSsm1oqRnOEe+RRvvVoAuIla1q5T
51kpCItGqwllvevUiuv20fDcZ+KKPXNHsfQPdwPCtz427LV+wl66rOr9b1BLAQIUAxQAAAAIAFGFPFuF+Ddc5QAAAKcBAAATAAAAAAAAAAAAAACAAQAAAABbQ29udGVu
dF9UeXBlc10ueG1sUEsBAhQDFAAAAAgAUYU8WzzDyG+oAAAAHQEAAAsAAAAAAAAAAAAAAIABFgEAAF9yZWxzLy5yZWxzUEsBAhQDFAAAAAgAUYU8W0w9fE5vAAAAfAAA
ABwAAAAAAAAAAAAAAIAB5wEAAHdvcmQvX3JlbHMvZG9jdW1lbnQueG1sLnJlbHNQSwECFAMUAAAACABRhTxbkGZU0+wBAADvBQAAEQAAAAAAAAAAAAAAgAGQAgAAd29y
ZC9kb2N1bWVudC54bWxQSwUGAAAAAAQABAADAQAAqwQAAAAA
""".strip()


_PDF_BASE64 = """
JVBERi0xLjMKMSAwIG9iago8PAovQ291bnQgMQovS2lkcyBbMyAwIFJdCi9NZWRpYUJveCBbMCAwIDU5NS4yOCA4NDEuODldCi9UeXBlIC9QYWdlcwo+PgplbmRvYmoKMiAwIG9iago8PAovT3BlbkFjdGlvbiBbMyAwIFIgL0ZpdEggbnVsbF0KL1BhZ2VMYXlvdXQgL09uZUNvbHVtbgovUGFnZXMgMSAwIFIKL1R5cGUgL0NhdGFsb2cKPj4KZW5kb2JqCjMgMCBvYmoKPDwKL0NvbnRlbnRzIDQgMCBSCi9QYXJlbnQgMSAwIFIKL1Jlc291cmNlcyA2IDAgUgovVHlwZSAvUGFnZQo+PgplbmRvYmoKNCAwIG9iago8PAovRmlsdGVyIC9GbGF0ZURlY29kZQovTGVuZ3RoIDgxCj4+CnN0cmVhbQp4nDNS8OIy0DM1VyjncgpR0HczVDA00jMwUAhJU3ANAQkZG+oZWiiYW5rqmZsrhKQoaHik5uTkKwS4uCnkJRYVJZZklqVqKoRkgZQDAJh8EvIKZW5kc3RyZWFtCmVuZG9iago1IDAgb2JqCjw8Ci9CYXNlRm9udCAvSGVsdmV0aWNhCi9FbmNvZGluZyAvV2luQW5zaUVuY29kaW5nCi9TdWJ0eXBlIC9UeXBlMQovVHlwZSAvRm9udAo+PgplbmRvYmoKNiAwIG9iago8PAovRm9udCA8PC9GMSA1IDAgUj4+Ci9Qcm9jU2V0IFsvUERGIC9UZXh0IC9JbWFnZUIgL0ltYWdlQyAvSW1hZ2VJXQo+PgplbmRvYmoKNyAwIG9iago8PAovQ3JlYXRpb25EYXRlIChEOjIwMjUwOTI4MTY0MDMyWikKPj4KZW5kb2JqCnhyZWYKMCA4CjAwMDAwMDAwMDAgNjU1MzUgZiAKMDAwMDAwMDAwOSAwMDAwMCBuIAowMDAwMDAwMDk2IDAwMDAwIG4gCjAwMDAwMDAxOTkgMDAwMDAgbiAKMDAwMDAwMDI3OSAwMDAwMCBuIAowMDAwMDAwNDMxIDAwMDAwIG4gCjAwMDAwMDA1MjggMDAwMDAgbiAKMDAwMDAwMDYxNSAwMDAwMCBuIAp0cmFpbGVyCjw8Ci9TaXplIDgKL1Jvb3QgMiAwIFIKL0luZm8gNyAwIFIKL0lEIFs8NEFBQTY4QzIzOUQ4MTk5Q0ZFQTJEODc1NURDQ0RFQzg+PDRBQUE2OEMyMzlEODE5OUNGRUEyRDg3NTVEQ0NERUM4Pl0KPj4Kc3RhcnR4cmVmCjY3MAolJUVPRgo=
""".strip()


def _decode(data: str) -> io.BytesIO:
    return io.BytesIO(base64.b64decode("".join(data.split())))


@pytest.mark.parametrize(
    ("payload", "filename", "expected"),
    [
        (io.BytesIO(b"Plain text narrative"), "sample.txt", "Plain text narrative"),
        (_decode(_DOCX_BASE64), "sample.docx", "Hello DOCX narrative"),
        (_decode(_PDF_BASE64), "sample.pdf", "Hello PDF narrative"),
    ],
)
def test_file_to_markdown(payload: io.BytesIO, filename: str, expected: str) -> None:
    result = file_to_markdown(payload, filename)
    assert expected in result
